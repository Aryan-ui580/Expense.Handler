<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Handler - Professional Expense Tracking System</title>
    <meta name="description" content="Professional expense tracking and management system. Track daily expenses, manage inventory stock, and monitor your budget with our easy-to-use financial tool.">
    <meta name="keywords" content="expense tracker, budget manager, financial tool, expense management, budget tracking, personal finance, stock management, inventory tracker">
    <meta name="author" content="Expense Handler">
    <meta name="robots" content="index, follow">

    <!-- Open Graph Meta Tags for Social Media -->
    <meta property="og:title" content="Expense Handler - Professional Expense Tracking">
    <meta property="og:description" content="Track your expenses and manage your budget with our professional expense tracking system.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://yourwebsite.com">

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüí∞%3C/text%3E%3C/svg%3E">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            background-image:
                radial-gradient(circle at 25% 25%, #e0e7ff 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, #dbeafe 0%, transparent 50%),
                linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: #1e293b;
            line-height: 1.6;
        }

        /* Geometric background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(90deg, rgba(59, 130, 246, 0.03) 1px, transparent 1px),
                linear-gradient(rgba(59, 130, 246, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 1;
        }

        /* Main container */
        .container {
            position: relative;
            z-index: 10;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 0;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 15px;
            font-weight: 800;
            color: #1e293b;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header .subtitle {
            font-size: 1.2rem;
            color: #64748b;
            margin-bottom: 20px;
        }

        .site-status {
            display: inline-block;
            padding: 10px 24px;
            border-radius: 50px;
            font-size: 0.95rem;
            font-weight: 600;
            border: 2px solid;
            transition: all 0.3s ease;
        }

        .site-active {
            background: #dcfce7;
            color: #166534;
            border-color: #22c55e;
        }

        .site-inactive {
            background: #fef2f2;
            color: #991b1b;
            border-color: #ef4444;
        }

        /* Profile Button */
        .profile-btn-container {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .profile-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 50px;
            padding: 8px 20px 8px 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-weight: 600;
            color: #1f2937;
        }

        .profile-btn:hover {
            border-color: #2563eb;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Hamburger Menu */
        .hamburger-menu {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: none;
        }

        .hamburger-btn {
            background: white;
            border: 2px solid #e2e8f0;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .hamburger-btn:hover {
            border-color: #2563eb;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .menu-dropdown {
            position: absolute;
            top: 60px;
            left: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            min-width: 220px;
            display: none;
            border: 1px solid #e2e8f0;
        }

        .menu-item {
            padding: 16px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .menu-item:hover {
            background: #f8fafc;
            color: #2563eb;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        /* Navigation */
        .nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 14px 28px;
            background: white;
            color: #64748b;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 16px;
        }

        .nav-btn:hover, .nav-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.3);
        }

        /* Pages */
        .page {
            display: none;
            animation: slideIn 0.6s ease;
        }

        .page.active {
            display: block !important;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            display: none;
            animation: slideIn 0.6s ease;
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2563eb, #3b82f6, #60a5fa);
            border-radius: 20px 20px 0 0;
        }

        .card.active {
            display: block !important;
        }

        .card h2 {
            color: #1e293b;
            font-weight: 700;
            margin-bottom: 30px;
            font-size: 2rem;
            text-align: center;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Forms */
        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 15px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fafafa;
            color: #1f2937;
        }

        .form-group input::placeholder, .form-group textarea::placeholder {
            color: #9ca3af;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #2563eb;
            background: white;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .form-group select {
            background: #fafafa;
            color: #1f2937;
        }

        .form-group select option {
            background: white;
            color: #1f2937;
        }

        /* Password input container */
        .password-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            color: #6b7280;
            transition: all 0.3s ease;
            padding: 8px 10px;
        }

        .password-toggle:hover {
            color: #2563eb;
            background: #eff6ff;
            border-color: #2563eb;
        }

        /* Text Captcha */
        .captcha {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }

        .captcha-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
            text-align: center;
        }

        .captcha-instruction {
            color: #6b7280;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
        }

        .captcha-math {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            letter-spacing: 3px;
        }

        .captcha-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .captcha-refresh {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .captcha-refresh:hover {
            background: #4b5563;
        }

        /* Expense Input Boxes */
        .expense-input-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .expense-box {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .expense-box:focus-within {
            border-color: #2563eb;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .expense-box label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            display: block;
        }

        .expense-box input, .expense-box textarea {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 16px;
            padding: 8px 0;
            resize: vertical;
            color: #1f2937;
        }

        .expense-box input:focus, .expense-box textarea:focus {
            outline: none;
        }

        .reason-box {
            grid-column: 1 / -1;
        }

        /* Buttons */
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
        }

        .btn-success {
            background: #059669;
            color: white;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }

        .btn-success:hover {
            background: #047857;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4);
        }

        .btn-danger {
            background: #dc2626;
            color: white;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .btn-danger:hover {
            background: #b91c1c;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
        }

        .btn-warning {
            background: #d97706;
            color: white;
            box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3);
        }

        .btn-warning:hover {
            background: #b45309;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(217, 119, 6, 0.4);
        }

        /* History Filters */
        .history-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #374151;
        }

        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .table th, .table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .table tr:hover {
            background: #f8fafc;
        }

        /* Rank badges */
        .rank-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .rank-gold { background: #f59e0b; }
        .rank-silver { background: #6b7280; }
        .rank-platinum { background: #8b5cf6; }
        .rank-diamond { background: #06b6d4; }
        .rank-vip { background: #ef4444; }
        .rank-vvip { background: #dc2626; }
        .rank-admin { background: #059669; }
        .rank-owner { background: #2563eb; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            margin: 15% auto;
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* Success message */
        .success-message {
            background: #dcfce7;
            color: #166534;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #bbf7d0;
            font-weight: 500;
        }

        /* History Items */
        .history-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .history-item:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-item-date {
            color: #6b7280;
            font-size: 14px;
        }

        .history-item-amount {
            font-weight: bold;
            color: #dc2626;
            font-size: 18px;
        }

        /* Features Section */
        .features-section {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .feature-card {
            text-align: center;
            padding: 30px 20px;
            border-radius: 16px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-color: #2563eb;
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .feature-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 15px;
        }

        .feature-description {
            color: #64748b;
            line-height: 1.6;
        }

        /* About Section */
        .about-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
        }

        .about-section h2 {
            color: white;
            margin-bottom: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .nav {
                flex-direction: column;
                align-items: center;
            }

            .card {
                padding: 20px;
            }

            .expense-input-container {
                grid-template-columns: 1fr;
            }

            .history-filters {
                grid-template-columns: 1fr;
            }

            .table {
                font-size: 14px;
            }

            .hamburger-menu {
                display: block;
            }

            .features-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none;
        }

        .logged-in .hamburger-menu {
            display: block;
        }

        .logged-in .nav {
            display: none;
        }

        .logged-in .features-section,
        .logged-in .about-section {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Hamburger Menu -->
    <div class="hamburger-menu" id="hamburgerMenu">
        <button class="hamburger-btn" onclick="toggleMenu()">‚ò∞</button>
        <div class="menu-dropdown" id="menuDropdown">
            <div class="menu-item" onclick="showMainDashboard()">üè† Dashboard</div>
            <div class="menu-item" onclick="showHistoryPage()">üìã History</div>
            <div class="menu-item" onclick="showFamilyPage()">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family</div>
            <div class="menu-item" id="stockMenuItem" onclick="showStockPage()" style="display: none;">üì¶ Check Stock</div>
            <div class="menu-item" id="adminMenuItem" onclick="showAdminPage()" style="display: none;">‚öôÔ∏è Admin Panel</div>
            <div class="menu-item" onclick="logout()">üö™ Logout</div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üí∞ Expense Handler</h1>
            <p class="subtitle">Professional expense tracking and management system for individuals and businesses</p>
            <div class="site-status site-active" id="siteStatus">üü¢ System Active</div>

            <!-- Profile Button (only shown when logged in) -->
            <div class="profile-btn-container" id="profileBtnContainer" style="display: none;">
                <button class="profile-btn" onclick="showProfileModal()">
                    <img id="headerProfilePic" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%232563eb'/%3E%3Ctext x='50' y='60' text-anchor='middle' fill='white' font-size='40' font-family='Arial'%3EU%3C/text%3E%3C/svg%3E" alt="Profile">
                    <span id="headerUsername">User</span>
                </button>
            </div>
        </header>

        <!-- Welcome Page (Landing Page) -->
        <div class="page" id="welcomePage">
            <!-- Navigation -->
            <nav class="nav" id="mainNav">
                <button class="nav-btn" onclick="showLoginPage()">üîê Login</button>
                <button class="nav-btn" onclick="showRegisterPage()">üìù Register</button>
            </nav>

            <!-- Features Section -->
            <section class="features-section">
                <h2 style="text-align: center; color: #1e293b; font-size: 2.5rem; margin-bottom: 20px;">üöÄ Why Choose Expense Handler?</h2>
                <p style="text-align: center; color: #64748b; font-size: 1.1rem; max-width: 600px; margin: 0 auto;">Take control of your finances with our comprehensive expense tracking and inventory management solution.</p>

                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">üí∏</div>
                        <h3 class="feature-title">Smart Expense Tracking</h3>
                        <p class="feature-description">Track daily expenses with detailed categorization, reasons, and automatic date stamping for complete financial oversight.</p>
                    </div>

                    <div class="feature-card">
                        <div class="feature-icon">üìä</div>
                        <h3 class="feature-title">Advanced Filtering</h3>
                        <p class="feature-description">Filter expenses by day, month, year, or custom date ranges to analyze spending patterns and trends.</p>
                    </div>

                    <div class="feature-card">
                        <div class="feature-icon">üì¶</div>
                        <h3 class="feature-title">Inventory Management</h3>
                        <p class="feature-description">Manage store stock with automatic low-level alerts and comprehensive inventory tracking capabilities.</p>
                    </div>

                    <div class="feature-card">
                        <div class="feature-icon">üîí</div>
                        <h3 class="feature-title">Secure & Private</h3>
                        <p class="feature-description">Your financial data stays secure with advanced captcha protection and user authentication systems.</p>
                    </div>

                    <div class="feature-card">
                        <div class="feature-icon">üì±</div>
                        <h3 class="feature-title">Mobile Responsive</h3>
                        <p class="feature-description">Access your expense data from any device - desktop, tablet, or mobile with our responsive design.</p>
                    </div>

                    <div class="feature-card">
                        <div class="feature-icon">‚ö°</div>
                        <h3 class="feature-title">Lightning Fast</h3>
                        <p class="feature-description">No loading times, no server delays. Everything works instantly right in your browser.</p>
                    </div>
                </div>
            </section>

            <!-- About Section -->
            <section class="about-section">
                <h2>üéØ Perfect for Everyone</h2>
                <p style="font-size: 1.1rem; line-height: 1.8; margin-bottom: 30px;">
                    Whether you're a small business owner tracking daily expenses, a store manager monitoring inventory levels,
                    or an individual looking to better manage personal finances, Expense Handler provides the tools you need
                    to stay organized and make informed financial decisions.
                </p>
                <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-top: 30px;">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üë•</div>
                        <strong>Personal Use</strong>
                        <p style="font-size: 0.9rem; opacity: 0.9;">Track personal expenses</p>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üè™</div>
                        <strong>Small Business</strong>
                        <p style="font-size: 0.9rem; opacity: 0.9;">Manage business expenses</p>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üìà</div>
                        <strong>Inventory Control</strong>
                        <p style="font-size: 0.9rem; opacity: 0.9;">Monitor stock levels</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Login Page -->
        <div class="page" id="loginPage" style="display: none;">
            <div style="text-align: center; margin-bottom: 30px;">
                <button class="btn" onclick="showWelcomePage()" style="background: #6b7280; color: white;">‚Üê Back to Home</button>
            </div>

            <!-- Success Message -->
            <div id="loginSuccessMessage" class="success-message hidden"></div>

            <div class="card active">
                <h2>üîê Login to Your Account</h2>
                <form onsubmit="login(event)">
                    <div class="form-group">
                        <label for="loginUsername">Username:</label>
                        <input type="text" id="loginUsername" name="username" placeholder="Enter your username" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password:</label>
                        <div class="password-container">
                            <input type="password" id="loginPassword" name="password" placeholder="Enter your password" required autocomplete="current-password">
                            <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)" aria-label="Toggle password visibility">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <div class="captcha" id="loginCaptcha">
                        <div class="captcha-title">Security Verification</div>
                        <div class="captcha-instruction" id="loginCaptchaInstruction">Enter the text shown below</div>
                        <div class="captcha-math" id="loginCaptchaMath" aria-label="Captcha code">ABC123</div>
                        <div class="captcha-controls">
                            <input type="text" id="loginCaptchaInput" placeholder="Enter captcha text" style="width: 150px; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; margin-right: 10px;" required>
                            <button type="button" class="captcha-refresh" onclick="refreshCaptcha('login')">üîÑ New Code</button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Login to Account</button>
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="button" class="btn" onclick="showForgotPassword()" style="background: transparent; color: #2563eb; text-decoration: underline; border: none; padding: 8px 16px;">Forgot Password?</button>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <p style="color: #6b7280;">Don't have an account? <button type="button" onclick="showRegisterPage()" style="background: none; border: none; color: #2563eb; text-decoration: underline; cursor: pointer;">Register here</button></p>
                    </div>
                </form>
            </div>
        </div>

        <!-- Register Page -->
        <div class="page" id="registerPage" style="display: none;">
            <div style="text-align: center; margin-bottom: 30px;">
                <button class="btn" onclick="showWelcomePage()" style="background: #6b7280; color: white;">‚Üê Back to Home</button>
            </div>

            <!-- Success Message -->
            <div id="registerSuccessMessage" class="success-message hidden"></div>

            <div class="card active">
                <h2>üìù Create New Account</h2>
                <form onsubmit="register(event)">
                    <div class="form-group">
                        <label for="regUsername">Username:</label>
                        <input type="text" id="regUsername" name="username" placeholder="Choose a unique username" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="regEmail">Email Address:</label>
                        <input type="email" id="regEmail" name="email" placeholder="Enter your email address" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="regPassword">Password:</label>
                        <div class="password-container">
                            <input type="password" id="regPassword" name="password" placeholder="Create a secure password" required autocomplete="new-password">
                            <button type="button" class="password-toggle" onclick="togglePassword('regPassword', this)" aria-label="Toggle password visibility">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="regPurpose">Account Purpose:</label>
                        <select id="regPurpose" name="purpose" required>
                            <option value="">Select your primary use case</option>
                            <option value="stock">Store Stock Management</option>
                            <option value="expenses">Daily Expense Tracking</option>
                            <option value="both">Both Features</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="accountType">Account Type:</label>
                        <select id="accountType" name="accountType" required onchange="toggleFamilyOptions()">
                            <option value="">Select account type</option>
                            <option value="individual">Individual Account</option>
                            <option value="family_head">Family Account (Head)</option>
                            <option value="family_member">Join Family Account</option>
                        </select>
                    </div>
                    <div id="familyOptions" style="display: none;">
                        <div class="form-group" id="familyNameGroup" style="display: none;">
                            <label for="familyName">Family Name:</label>
                            <input type="text" id="familyName" name="familyName" placeholder="Enter your family name (e.g., Smith Family)">
                        </div>
                        <div class="form-group" id="familyCodeGroup" style="display: none;">
                            <label for="familyCode">Family Code:</label>
                            <input type="text" id="familyCode" name="familyCode" placeholder="Enter family code to join" maxlength="8">
                            <small style="color: #6b7280; font-size: 14px; margin-top: 5px; display: block;">Ask your family head for the 8-digit family code</small>
                        </div>
                    </div>
                    <div class="captcha" id="registerCaptcha">
                        <div class="captcha-title">Security Verification</div>
                        <div class="captcha-instruction" id="registerCaptchaInstruction">Enter the text shown below</div>
                        <div class="captcha-math" id="registerCaptchaMath" aria-label="Captcha code">XYZ789</div>
                        <div class="captcha-controls">
                            <input type="text" id="registerCaptchaInput" placeholder="Enter captcha text" style="width: 150px; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; margin-right: 10px;" required>
                            <button type="button" class="captcha-refresh" onclick="refreshCaptcha('register')">üîÑ New Code</button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Account</button>
                    <div style="text-align: center; margin-top: 15px;">
                        <p style="color: #6b7280;">Already have an account? <button type="button" onclick="showLoginPage()" style="background: none; border: none; color: #2563eb; text-decoration: underline; cursor: pointer;">Login here</button></p>
                    </div>
                </form>
            </div>
        </div>

        <!-- Dashboard Page (After Login) -->
        <div class="page" id="dashboardPage" style="display: none;">
            <!-- Success Message -->
            <div id="dashboardSuccessMessage" class="success-message hidden"></div>

            <div class="card active">
                <h2>üí∏ Add New Expense</h2>
                <form onsubmit="addExpense(event)">
                    <div class="expense-input-container">
                        <div class="expense-box">
                            <label for="expenseDescription">üìù Description</label>
                            <input type="text" id="expenseDescription" name="description" placeholder="What did you spend on?" required>
                        </div>
                        <div class="expense-box">
                            <label for="expenseAmount">üí∞ Amount (‚Çπ)</label>
                            <input type="number" id="expenseAmount" name="amount" placeholder="0.00" step="0.01" min="0" required>
                        </div>
                        <div class="expense-box">
                            <label for="expenseCategory">üè∑Ô∏è Category</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="expenseCategory" name="category" required style="flex: 1; border: none; background: transparent; font-size: 16px; padding: 8px 0;">
                                    <option value="">Select category</option>
                                </select>
                                <button type="button" onclick="showAddCategoryModal()" style="background: #2563eb; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;">+</button>
                            </div>
                        </div>
                        <div class="expense-box reason-box">
                            <label for="expenseReason">üìã Reason for this expense</label>
                            <textarea id="expenseReason" name="reason" placeholder="Why was this expense necessary? (Optional)" rows="3"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">Add Expense</button>
                </form>
            </div>
        </div>

        <!-- Forgot Password Page -->
        <div class="page" id="forgotPasswordPage" style="display: none;">
            <div style="text-align: center; margin-bottom: 30px;">
                <button class="btn" onclick="showLoginPage()" style="background: #6b7280; color: white;">‚Üê Back to Login</button>
            </div>

            <div class="card active">
                <h2>üîë Reset Your Password</h2>
                <div id="forgotPasswordStep1">
                    <p style="color: #64748b; margin-bottom: 30px; text-align: center;">Enter your email address and we'll help you reset your password.</p>
                    <form onsubmit="sendResetCode(event)">
                        <div class="form-group">
                            <label for="forgotEmail">Email Address:</label>
                            <input type="email" id="forgotEmail" name="email" placeholder="Enter your registered email" required autocomplete="email">
                        </div>
                        <div class="captcha" id="forgotCaptcha">
                            <div class="captcha-title">Security Verification</div>
                            <div class="captcha-instruction" id="forgotCaptchaInstruction">Enter the text shown below</div>
                            <div class="captcha-math" id="forgotCaptchaMath" aria-label="Captcha code">DEF456</div>
                            <div class="captcha-controls">
                                <input type="text" id="forgotCaptchaInput" placeholder="Enter captcha text" style="width: 150px; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; margin-right: 10px;" required>
                                <button type="button" class="captcha-refresh" onclick="refreshCaptcha('forgot')">üîÑ New Code</button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Send Reset Code</button>
                    </form>
                </div>

                <div id="forgotPasswordStep2" style="display: none;">
                    <p style="color: #64748b; margin-bottom: 30px; text-align: center;">We've sent a 6-digit verification code to your email. Enter it below along with your new password.</p>
                    <form onsubmit="resetPassword(event)">
                        <div class="form-group">
                            <label for="resetCode">Verification Code:</label>
                            <input type="text" id="resetCode" name="code" placeholder="Enter 6-digit code" maxlength="6" required style="text-align: center; font-size: 18px; letter-spacing: 3px; font-family: monospace;">
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password:</label>
                            <div class="password-container">
                                <input type="password" id="newPassword" name="password" placeholder="Enter your new password" required autocomplete="new-password">
                                <button type="button" class="password-toggle" onclick="togglePassword('newPassword', this)" aria-label="Toggle password visibility">üëÅÔ∏è</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm New Password:</label>
                            <div class="password-container">
                                <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm your new password" required autocomplete="new-password">
                                <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword', this)" aria-label="Toggle password visibility">üëÅÔ∏è</button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Reset Password</button>
                        <button type="button" class="btn" onclick="backToStep1()" style="background: #6b7280; color: white; margin-left: 10px;">Back</button>
                    </form>
                </div>

                <div id="forgotPasswordStep3" style="display: none;">
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">‚úÖ</div>
                        <h3 style="color: #059669; margin-bottom: 15px;">Password Reset Successful!</h3>
                        <p style="color: #64748b; margin-bottom: 30px;">Your password has been successfully reset. You can now login with your new password.</p>
                        <button class="btn btn-primary" onclick="showLoginPage()">Go to Login</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Page -->
        <div class="page" id="historyPage" style="display: none;">
            <div class="card active">
                <h2>üìã Expense History</h2>
                <div class="history-filters">
                    <div class="filter-group">
                        <label for="filterDay">Day:</label>
                        <select id="filterDay" name="filterDay">
                            <option value="">All Days</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterMonth">Month:</label>
                        <select id="filterMonth" name="filterMonth">
                            <option value="">All Months</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterYear">Year:</label>
                        <select id="filterYear" name="filterYear">
                            <option value="">All Years</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterCategory">Category:</label>
                        <select id="filterCategory" name="filterCategory">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-primary" onclick="filterHistory()">Apply Filter</button>
                    </div>
                </div>
                <div id="historyList"></div>
            </div>
        </div>

        <!-- Stock Page -->
        <div class="page" id="stockPage" style="display: none;">
            <div class="card active">
                <h2>üì¶ Stock Management</h2>
                <form onsubmit="addStock(event)" style="margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
                        <div class="form-group">
                            <label for="stockItem">Item Name:</label>
                            <input type="text" id="stockItem" name="item" placeholder="Enter item name" required>
                        </div>
                        <div class="form-group">
                            <label for="stockQuantity">Quantity:</label>
                            <input type="number" id="stockQuantity" name="quantity" placeholder="0" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="stockMinLevel">Min Level:</label>
                            <input type="number" id="stockMinLevel" name="minLevel" placeholder="0" min="0" required>
                        </div>
                        <button type="submit" class="btn btn-success">Add Stock</button>
                    </div>
                </form>

                <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="filterStock('in-stock')">‚úÖ In Stock</button>
                    <button class="btn btn-danger" onclick="filterStock('out-of-stock')">‚ùå Out of Stock</button>
                    <button class="btn btn-primary" onclick="filterStock('all')">üìã All Items</button>
                </div>

                <div id="stockList"></div>
            </div>
        </div>

        <!-- Family Page -->
        <div class="page" id="familyPage" style="display: none;">
            <div class="card active">
                <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Account Management</h2>

                <!-- Family Head Section -->
                <div id="familyHeadSection" style="display: none;">
                    <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                        <h3 style="color: #166534; margin-bottom: 15px;">üëë Family Head Dashboard</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <strong>Family Name:</strong> <span id="familyNameDisplay"></span>
                            </div>
                            <div>
                                <strong>Family Code:</strong>
                                <span id="familyCodeDisplay" style="font-family: monospace; background: #dcfce7; padding: 4px 8px; border-radius: 6px; font-weight: bold;"></span>
                                <button onclick="copyFamilyCode()" style="margin-left: 10px; background: #22c55e; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">üìã Copy</button>
                            </div>
                        </div>
                        <p style="color: #166534; margin-bottom: 15px;">Share the family code with your family members so they can join your account.</p>
                        <button class="btn btn-primary" onclick="showInviteMemberModal()">+ Invite Family Member</button>
                    </div>

                    <!-- Family Members List -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #374151; margin-bottom: 15px;">üë• Family Members</h3>
                        <div id="familyMembersList"></div>
                    </div>

                    <!-- Family Expenses Overview -->
                    <div>
                        <h3 style="color: #374151; margin-bottom: 15px;">üí∞ Family Expenses Overview</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 10px;">üí∏</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #1e40af;" id="totalFamilyExpenses">‚Çπ0.00</div>
                                <div style="color: #6b7280;">Total Family Expenses</div>
                            </div>
                            <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 10px;">üë•</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #166534;" id="totalFamilyMembers">0</div>
                                <div style="color: #6b7280;">Family Members</div>
                            </div>
                        </div>

                        <!-- Member-wise Expense Breakdown -->
                        <div id="memberExpenseBreakdown"></div>
                    </div>
                </div>

                <!-- Family Member Section -->
                <div id="familyMemberSection" style="display: none;">
                    <div style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                        <h3 style="color: #1e40af; margin-bottom: 15px;">üë§ Family Member Dashboard</h3>
                        <div style="margin-bottom: 15px;">
                            <strong>Family:</strong> <span id="memberFamilyName"></span>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Your Role:</strong> <span style="background: #dbeafe; color: #1e40af; padding: 4px 12px; border-radius: 20px; font-size: 14px;">Family Member</span>
                        </div>
                        <p style="color: #1e40af;">Your expenses are visible to the family head for better family budget management.</p>
                    </div>

                    <!-- Member's Personal Stats -->
                    <div>
                        <h3 style="color: #374151; margin-bottom: 15px;">üìä Your Expense Summary</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 10px;">üí∞</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #d97706;" id="memberTotalExpenses">‚Çπ0.00</div>
                                <div style="color: #6b7280;">Your Total Expenses</div>
                            </div>
                            <div style="background: #e0e7ff; border: 2px solid #6366f1; border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 10px;">üìÖ</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #4f46e5;" id="memberThisMonth">‚Çπ0.00</div>
                                <div style="color: #6b7280;">This Month</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Individual Account Section -->
                <div id="individualAccountSection" style="display: none;">
                    <div style="background: #f3f4f6; border: 2px solid #6b7280; border-radius: 12px; padding: 20px; text-align: center;">
                        <h3 style="color: #374151; margin-bottom: 15px;">üë§ Individual Account</h3>
                        <p style="color: #6b7280; margin-bottom: 20px;">You have an individual account. You can create a family account or join an existing one.</p>
                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="showCreateFamilyModal()">üëë Create Family Account</button>
                            <button class="btn btn-success" onclick="showJoinFamilyModal()">üë• Join Family Account</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel Page -->
        <div class="page" id="adminPage" style="display: none;">
            <div class="card active">
                <h2>‚öôÔ∏è Admin Panel</h2>

                <div style="margin-bottom: 30px;">
                    <h3 style="color: #374151; margin-bottom: 15px;">üåê System Control</h3>
                    <button class="btn btn-success" onclick="toggleSite(true)">Activate System</button>
                    <button class="btn btn-danger" onclick="toggleSite(false)">Deactivate System</button>
                </div>

                <div>
                    <h3 style="color: #374151; margin-bottom: 15px;">üë• User Management</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Current Rank</th>
                                <th>Purpose</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersList">
                            <tr>
                                <td>demo_user</td>
                                <td>demo@example.com</td>
                                <td><span class="rank-badge rank-gold">Gold</span></td>
                                <td>Both</td>
                                <td>
                                    <select onchange="changeUserRank('demo_user', this.value)" style="padding: 4px 8px; border-radius: 6px; border: 1px solid #d1d5db;">
                                        <option value="gold" selected>Gold</option>
                                        <option value="silver">Silver</option>
                                        <option value="platinum">Platinum</option>
                                        <option value="diamond">Diamond</option>
                                        <option value="vip">VIP</option>
                                        <option value="vvip">VVIP</option>
                                        <option value="admin">Admin</option>
                                        <option value="owner">Owner</option>
                                    </select>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal" role="dialog" aria-labelledby="confirmTitle" aria-describedby="confirmMessage">
        <div class="modal-content">
            <h3 id="confirmTitle" style="color: #1f2937; margin-bottom: 15px;">Confirm Action</h3>
            <p id="confirmMessage" style="color: #6b7280; margin-bottom: 25px;">Are you sure you want to proceed?</p>
            <div style="margin-top: 20px;">
                <button class="btn btn-danger" onclick="confirmAction()">Yes, Proceed</button>
                <button class="btn" onclick="closeModal()" style="background: #6b7280; color: white;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="modal" role="dialog" aria-labelledby="addCategoryTitle">
        <div class="modal-content" style="max-width: 400px;">
            <h3 id="addCategoryTitle" style="color: #1f2937; margin-bottom: 25px; text-align: center;">üè∑Ô∏è Add New Category</h3>

            <form onsubmit="addNewCategory(event)">
                <div class="form-group">
                    <label for="newCategoryName">Category Name:</label>
                    <input type="text" id="newCategoryName" name="categoryName" placeholder="Enter category name" required maxlength="30">
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn btn-success">Add Category</button>
                    <button type="button" class="btn" onclick="closeAddCategoryModal()" style="background: #6b7280; color: white; margin-left: 10px;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal" role="dialog" aria-labelledby="profileModalTitle">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="profileModalTitle" style="color: #1f2937; margin-bottom: 25px; text-align: center;">üë§ User Profile</h3>

            <!-- Profile Picture Section -->
            <div style="text-align: center; margin-bottom: 30px;">
                <img id="profilePicture" src="" alt="Profile Picture" style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid #e2e8f0; margin-bottom: 20px; object-fit: cover;">
                <div>
                    <button class="btn btn-primary" onclick="showAvatarSelection()" style="margin-right: 10px;">Choose Avatar</button>
                    <input type="file" id="profilePicInput" accept="image/*" style="display: none;" onchange="handleProfilePicUpload(event)">
                    <button class="btn btn-success" onclick="document.getElementById('profilePicInput').click()">Upload Photo</button>
                </div>
            </div>

            <!-- Avatar Selection -->
            <div id="avatarSelection" style="display: none; margin-bottom: 20px;">
                <h4 style="margin-bottom: 15px; color: #374151;">Choose an Avatar:</h4>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;" id="avatarGrid"></div>
                <button class="btn" onclick="hideAvatarSelection()" style="background: #6b7280; color: white;">Cancel</button>
            </div>

            <!-- User Info -->
            <div style="margin-bottom: 20px;">
                <div class="form-group">
                    <label for="profileUsername">Username:</label>
                    <input type="text" id="profileUsername" name="profileUsername" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label for="profileEmail">Email:</label>
                    <input type="email" id="profileEmail" name="profileEmail" readonly style="background: #f3f4f6; color: #6b7280;">
                </div>
                <div class="form-group">
                    <label>Rank:</label>
                    <div style="padding: 12px 16px; background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 12px;">
                        <span id="profileRank" class="rank-badge rank-gold">Gold</span>
                    </div>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
                <button class="btn" onclick="closeProfileModal()" style="background: #6b7280; color: white;">Close</button>
            </div>
        </div>
    </div>

    <!-- Create Family Modal -->
    <div id="createFamilyModal" class="modal" role="dialog" aria-labelledby="createFamilyTitle">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="createFamilyTitle" style="color: #1f2937; margin-bottom: 25px; text-align: center;">üëë Create Family Account</h3>

            <form onsubmit="createFamily(event)">
                <div class="form-group">
                    <label for="createFamilyName">Family Name:</label>
                    <input type="text" id="createFamilyName" name="familyName" placeholder="Enter your family name (e.g., Smith Family)" required maxlength="50">
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn btn-primary">Create Family Account</button>
                    <button type="button" class="btn" onclick="closeCreateFamilyModal()" style="background: #6b7280; color: white; margin-left: 10px;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Join Family Modal -->
    <div id="joinFamilyModal" class="modal" role="dialog" aria-labelledby="joinFamilyTitle">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="joinFamilyTitle" style="color: #1f2937; margin-bottom: 25px; text-align: center;">üë• Join Family Account</h3>

            <form onsubmit="joinFamily(event)">
                <div class="form-group">
                    <label for="joinFamilyCode">Family Code:</label>
                    <input type="text" id="joinFamilyCode" name="familyCode" placeholder="Enter 8-digit family code" required maxlength="8" style="text-align: center; font-family: monospace; font-size: 18px; letter-spacing: 2px;">
                    <small style="color: #6b7280; font-size: 14px; margin-top: 5px; display: block;">Ask your family head for the family code</small>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn btn-success">Join Family</button>
                    <button type="button" class="btn" onclick="closeJoinFamilyModal()" style="background: #6b7280; color: white; margin-left: 10px;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invite Member Modal -->
    <div id="inviteMemberModal" class="modal" role="dialog" aria-labelledby="inviteMemberTitle">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="inviteMemberTitle" style="color: #1f2937; margin-bottom: 25px; text-align: center;">üìß Invite Family Member</h3>

            <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
                <h4 style="color: #166534; margin-bottom: 15px;">Share Your Family Code</h4>
                <div style="font-family: monospace; font-size: 24px; font-weight: bold; color: #166534; background: #dcfce7; padding: 15px; border-radius: 8px; margin-bottom: 15px;" id="inviteCodeDisplay"></div>
                <button onclick="copyInviteCode()" style="background: #22c55e; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">üìã Copy Code</button>
            </div>

            <div style="color: #6b7280; text-align: center; line-height: 1.6;">
                <p><strong>Instructions for your family member:</strong></p>
                <ol style="text-align: left; margin: 15px 0;">
                    <li>Register for a new account</li>
                    <li>Select "Join Family Account" as account type</li>
                    <li>Enter this family code during registration</li>
                </ol>
                <p style="font-size: 14px; color: #ef4444;"><strong>Note:</strong> Keep this code private and only share with trusted family members.</p>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="closeInviteMemberModal()" style="background: #6b7280; color: white;">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let siteActive = true;
        let expenses = [];
        let stock = [];
        let registeredUsers = [];
        let families = [];
        let confirmCallback = null;
        let captchaData = {};
        let categories = ['Medical', 'Shopping', 'Groceries', 'Daily Expense'];

        // Captcha data
        let captchaAnswers = {};

        // Email validation function
        function validateEmail(email) {
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            return emailRegex.test(email);
        }

        // Password reset data
        let resetData = {
            email: '',
            code: '',
            timestamp: 0
        };

        // Local Storage Functions
        function saveToStorage() {
            try {
                localStorage.setItem('expenseHandler_users', JSON.stringify(registeredUsers));
                localStorage.setItem('expenseHandler_expenses', JSON.stringify(expenses));
                localStorage.setItem('expenseHandler_stock', JSON.stringify(stock));
                localStorage.setItem('expenseHandler_families', JSON.stringify(families));
                localStorage.setItem('expenseHandler_currentUser', JSON.stringify(currentUser));
                localStorage.setItem('expenseHandler_siteActive', JSON.stringify(siteActive));
                localStorage.setItem('expenseHandler_categories', JSON.stringify(categories));
            } catch (error) {
                console.log('Storage not available');
            }
        }

        function loadFromStorage() {
            try {
                const savedUsers = localStorage.getItem('expenseHandler_users');
                const savedExpenses = localStorage.getItem('expenseHandler_expenses');
                const savedStock = localStorage.getItem('expenseHandler_stock');
                const savedFamilies = localStorage.getItem('expenseHandler_families');
                const savedCurrentUser = localStorage.getItem('expenseHandler_currentUser');
                const savedSiteActive = localStorage.getItem('expenseHandler_siteActive');
                const savedCategories = localStorage.getItem('expenseHandler_categories');

                if (savedUsers) registeredUsers = JSON.parse(savedUsers);
                if (savedExpenses) expenses = JSON.parse(savedExpenses);
                if (savedStock) stock = JSON.parse(savedStock);
                if (savedFamilies) families = JSON.parse(savedFamilies);
                if (savedCategories) categories = JSON.parse(savedCategories);
                if (savedCurrentUser) {
                    currentUser = JSON.parse(savedCurrentUser);
                    if (currentUser) {
                        // Restore logged in state
                        document.body.classList.add('logged-in');
                        updateProfileButton();

                        // Show appropriate menu items
                        if (currentUser.rank === 'admin') {
                            document.getElementById('adminMenuItem').style.display = 'block';
                            document.getElementById('stockMenuItem').style.display = 'block';
                        } else if (currentUser.purpose === 'stock' || currentUser.purpose === 'both') {
                            document.getElementById('stockMenuItem').style.display = 'block';
                        }
                    }
                }
                if (savedSiteActive) {
                    siteActive = JSON.parse(savedSiteActive);
                    const statusEl = document.getElementById('siteStatus');
                    statusEl.textContent = siteActive ? 'üü¢ System Active' : 'üî¥ System Inactive';
                    statusEl.className = `site-status ${siteActive ? 'site-active' : 'site-inactive'}`;
                }
            } catch (error) {
                console.log('Error loading from storage');
            }
        }

        // Avatar options
        const avatarOptions = [
            "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%232563eb'/%3E%3Ctext x='50' y='60' text-anchor='middle' fill='white' font-size='40' font-family='Arial'%3Eüòä%3C/text%3E%3C/svg%3E",
            "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23059669'/%3E%3Ctext x='50' y='60' text-anchor='middle' fill='white' font-size='40' font-family='Arial'%3Eüòé%3C/text%3E%3C/svg%3E",
            "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23dc2626'/%3E%3Ctext x='50' y='60' text-anchor='middle' fill='white' font-size='40' font-family='Arial'%3EüöÄ%3C/text%3E%3C/svg%3E",
            "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23d97706'/%3E%3Ctext x='50' y='60' text-anchor='middle' fill='white' font-size='40' font-family='Arial'%3EüéØ%3C/text%3E%3C/svg%3E",
            "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%238b5cf6'/%3E%3Ctext x='50' y='60' text-anchor='middle' fill='white' font-size='40' font-family='Arial'%3Eüíé%3C/text%3E%3C/svg%3E",
            "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%2306b6d4'/%3E%3Ctext x='50' y='60' text-anchor='middle' fill='white' font-size='40' font-family='Arial'%3E‚≠ê%3C/text%3E%3C/svg%3E",
            "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23ef4444'/%3E%3Ctext x='50' y='60' text-anchor='middle' fill='white' font-size='40' font-family='Arial'%3Eüî•%3C/text%3E%3C/svg%3E",
            "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23f59e0b'/%3E%3Ctext x='50' y='60' text-anchor='middle' fill='white' font-size='40' font-family='Arial'%3Eüé®%3C/text%3E%3C/svg%3E"
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved data first
            loadFromStorage();

            refreshCaptcha('login');
            refreshCaptcha('register');
            refreshCaptcha('forgot');
            initializeFilters();
            updateCategoryDropdowns();
            updateStockList();
            updateHistoryList();

            // Show welcome page only if not logged in
            if (!currentUser) {
                showWelcomePage();
            } else {
                showDashboardPage();
            }
        });

        // Category Functions
        function updateCategoryDropdowns() {
            // Update expense form category dropdown
            const expenseCategorySelect = document.getElementById('expenseCategory');
            expenseCategorySelect.innerHTML = '<option value="">Select category</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                expenseCategorySelect.appendChild(option);
            });

            // Update history filter category dropdown
            const filterCategorySelect = document.getElementById('filterCategory');
            filterCategorySelect.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                filterCategorySelect.appendChild(option);
            });
        }

        function showAddCategoryModal() {
            document.getElementById('addCategoryModal').style.display = 'block';
            document.getElementById('newCategoryName').value = '';
        }

        function closeAddCategoryModal() {
            document.getElementById('addCategoryModal').style.display = 'none';
        }

        function addNewCategory(event) {
            event.preventDefault();
            const categoryName = document.getElementById('newCategoryName').value.trim();

            if (!categoryName) {
                alert('Please enter a category name!');
                return;
            }

            if (categories.includes(categoryName)) {
                alert('This category already exists!');
                return;
            }

            categories.push(categoryName);
            updateCategoryDropdowns();
            saveToStorage();
            closeAddCategoryModal();

            // Show success message
            document.getElementById('successMessage').textContent = `‚úÖ Category "${categoryName}" added successfully!`;
            document.getElementById('successMessage').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('successMessage').classList.add('hidden');
            }, 2000);
        }

        // Initialize filter dropdowns
        function initializeFilters() {
            // Populate days
            const daySelect = document.getElementById('filterDay');
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i.toString().padStart(2, '0');
                option.textContent = i;
                daySelect.appendChild(option);
            }

            // Populate years
            const yearSelect = document.getElementById('filterYear');
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= currentYear - 10; i--) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }
        }

        // Captcha Functions
        function refreshCaptcha(type) {
            // Generate random alphanumeric string
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let captchaText = '';
            for (let i = 0; i < 6; i++) {
                captchaText += chars.charAt(Math.floor(Math.random() * chars.length));
            }

            captchaAnswers[type] = captchaText;
            document.getElementById(type + 'CaptchaMath').textContent = captchaText;
            document.getElementById(type + 'CaptchaInput').value = '';
        }

        function validateCaptcha(type) {
            const userAnswer = document.getElementById(type + 'CaptchaInput').value.toUpperCase();
            const correctAnswer = captchaAnswers[type];
            return userAnswer === correctAnswer;
        }

        // Navigation
        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
                page.classList.remove('active');
            });

            // Show the requested page
            const targetPage = document.getElementById(pageName + 'Page');
            if (targetPage) {
                targetPage.style.display = 'block';
                targetPage.classList.add('active');
            }
        }

        // Family Functions
        function toggleFamilyOptions() {
            const accountType = document.getElementById('accountType').value;
            const familyOptions = document.getElementById('familyOptions');
            const familyNameGroup = document.getElementById('familyNameGroup');
            const familyCodeGroup = document.getElementById('familyCodeGroup');

            if (accountType === 'family_head') {
                familyOptions.style.display = 'block';
                familyNameGroup.style.display = 'block';
                familyCodeGroup.style.display = 'none';
                document.getElementById('familyName').required = true;
                document.getElementById('familyCode').required = false;
            } else if (accountType === 'family_member') {
                familyOptions.style.display = 'block';
                familyNameGroup.style.display = 'none';
                familyCodeGroup.style.display = 'block';
                document.getElementById('familyName').required = false;
                document.getElementById('familyCode').required = true;
            } else {
                familyOptions.style.display = 'none';
                document.getElementById('familyName').required = false;
                document.getElementById('familyCode').required = false;
            }
        }

        function generateFamilyCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function createFamily(event) {
            event.preventDefault();
            const familyName = document.getElementById('createFamilyName').value.trim();

            if (!familyName) {
                alert('Please enter a family name!');
                return;
            }

            // Generate unique family code
            let familyCode;
            do {
                familyCode = generateFamilyCode();
            } while (families.find(f => f.code === familyCode));

            // Create family
            const family = {
                id: Date.now(),
                name: familyName,
                code: familyCode,
                headId: currentUser.email,
                members: [currentUser.email],
                createdAt: new Date().toISOString()
            };

            families.push(family);

            // Update current user
            currentUser.accountType = 'family_head';
            currentUser.familyId = family.id;

            // Update user in registered users
            const userIndex = registeredUsers.findIndex(u => u.email === currentUser.email);
            if (userIndex !== -1) {
                registeredUsers[userIndex] = currentUser;
            }

            saveToStorage();
            closeCreateFamilyModal();
            updateFamilyPage();

            alert(`‚úÖ Family account "${familyName}" created successfully!\nFamily Code: ${familyCode}\nShare this code with your family members.`);
        }

        function joinFamily(event) {
            event.preventDefault();
            const familyCode = document.getElementById('joinFamilyCode').value.trim().toUpperCase();

            if (!familyCode) {
                alert('Please enter a family code!');
                return;
            }

            // Find family by code
            const family = families.find(f => f.code === familyCode);
            if (!family) {
                alert('Invalid family code! Please check and try again.');
                return;
            }

            // Check if user is already in a family
            if (currentUser.familyId) {
                alert('You are already part of a family account!');
                return;
            }

            // Add user to family
            family.members.push(currentUser.email);

            // Update current user
            currentUser.accountType = 'family_member';
            currentUser.familyId = family.id;

            // Update user in registered users
            const userIndex = registeredUsers.findIndex(u => u.email === currentUser.email);
            if (userIndex !== -1) {
                registeredUsers[userIndex] = currentUser;
            }

            saveToStorage();
            closeJoinFamilyModal();
            updateFamilyPage();

            alert(`‚úÖ Successfully joined "${family.name}"!\nYou are now part of the family account.`);
        }

        function updateFamilyPage() {
            if (!currentUser) return;

            const familyHeadSection = document.getElementById('familyHeadSection');
            const familyMemberSection = document.getElementById('familyMemberSection');
            const individualAccountSection = document.getElementById('individualAccountSection');

            // Hide all sections first
            familyHeadSection.style.display = 'none';
            familyMemberSection.style.display = 'none';
            individualAccountSection.style.display = 'none';

            if (currentUser.accountType === 'family_head') {
                const family = families.find(f => f.id === currentUser.familyId);
                if (family) {
                    familyHeadSection.style.display = 'block';
                    document.getElementById('familyNameDisplay').textContent = family.name;
                    document.getElementById('familyCodeDisplay').textContent = family.code;
                    updateFamilyStats(family);
                    updateFamilyMembersList(family);
                }
            } else if (currentUser.accountType === 'family_member') {
                const family = families.find(f => f.id === currentUser.familyId);
                if (family) {
                    familyMemberSection.style.display = 'block';
                    document.getElementById('memberFamilyName').textContent = family.name;
                    updateMemberStats();
                }
            } else {
                individualAccountSection.style.display = 'block';
            }
        }

        function updateFamilyStats(family) {
            // Calculate total family expenses
            const familyExpenses = expenses.filter(expense =>
                family.members.includes(registeredUsers.find(u => u.username === expense.user)?.email)
            );

            const totalAmount = familyExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('totalFamilyExpenses').textContent = `‚Çπ${totalAmount.toFixed(2)}`;
            document.getElementById('totalFamilyMembers').textContent = family.members.length;

            // Update member expense breakdown
            updateMemberExpenseBreakdown(family);
        }

        function updateMemberExpenseBreakdown(family) {
            const breakdown = document.getElementById('memberExpenseBreakdown');
            const memberStats = [];

            family.members.forEach(memberEmail => {
                const user = registeredUsers.find(u => u.email === memberEmail);
                if (user) {
                    const userExpenses = expenses.filter(expense => expense.user === user.username);
                    const totalAmount = userExpenses.reduce((sum, expense) => sum + expense.amount, 0);

                    memberStats.push({
                        username: user.username,
                        email: memberEmail,
                        totalExpenses: totalAmount,
                        expenseCount: userExpenses.length,
                        isHead: memberEmail === family.headId
                    });
                }
            });

            breakdown.innerHTML = `
                <h4 style="color: #374151; margin-bottom: 15px;">üë• Member-wise Expense Breakdown</h4>
                <div style="display: grid; gap: 15px;">
                    ${memberStats.map(member => `
                        <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">
                                    ${member.username} ${member.isHead ? 'üëë' : ''}
                                </div>
                                <div style="color: #6b7280; font-size: 14px;">${member.email}</div>
                                <div style="color: #6b7280; font-size: 14px; margin-top: 5px;">${member.expenseCount} expenses</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: ${member.totalExpenses > 0 ? '#dc2626' : '#6b7280'};">
                                    ‚Çπ${member.totalExpenses.toFixed(2)}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateMemberStats() {
            const userExpenses = expenses.filter(expense => expense.user === currentUser.username);
            const totalAmount = userExpenses.reduce((sum, expense) => sum + expense.amount, 0);

            // Calculate this month's expenses
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const thisMonthExpenses = userExpenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });
            const thisMonthAmount = thisMonthExpenses.reduce((sum, expense) => sum + expense.amount, 0);

            document.getElementById('memberTotalExpenses').textContent = `‚Çπ${totalAmount.toFixed(2)}`;
            document.getElementById('memberThisMonth').textContent = `‚Çπ${thisMonthAmount.toFixed(2)}`;
        }

        function updateFamilyMembersList(family) {
            const membersList = document.getElementById('familyMembersList');
            const members = [];

            family.members.forEach(memberEmail => {
                const user = registeredUsers.find(u => u.email === memberEmail);
                if (user) {
                    members.push({
                        ...user,
                        isHead: memberEmail === family.headId
                    });
                }
            });

            membersList.innerHTML = members.map(member => `
                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <img src="${member.profilePic || avatarOptions[0]}" alt="Profile" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                        <div>
                            <div style="font-weight: bold; color: #1f2937;">
                                ${member.username} ${member.isHead ? 'üëë' : ''}
                            </div>
                            <div style="color: #6b7280; font-size: 14px;">${member.email}</div>
                            <span class="rank-badge rank-${member.rank}" style="font-size: 12px; margin-top: 5px; display: inline-block;">
                                ${member.rank.charAt(0).toUpperCase() + member.rank.slice(1)}
                            </span>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        ${member.isHead ?
                            '<span style="color: #059669; font-weight: bold;">Family Head</span>' :
                            `<button class="btn btn-danger" onclick="removeFamilyMember('${member.email}')" style="padding: 6px 12px; font-size: 12px;">Remove</button>`
                        }
                    </div>
                </div>
            `).join('');
        }

        function removeFamilyMember(memberEmail) {
            if (!currentUser || currentUser.accountType !== 'family_head') {
                alert('Only family head can remove members!');
                return;
            }

            const family = families.find(f => f.id === currentUser.familyId);
            if (!family) return;

            const member = registeredUsers.find(u => u.email === memberEmail);
            if (!member) return;

            showConfirmModal('Remove Family Member',
                `Are you sure you want to remove ${member.username} from the family?`, () => {
                // Remove member from family
                family.members = family.members.filter(email => email !== memberEmail);

                // Update member's account type
                member.accountType = 'individual';
                member.familyId = null;

                saveToStorage();
                updateFamilyPage();

                alert(`${member.username} has been removed from the family.`);
            });
        }

        function copyFamilyCode() {
            const familyCode = document.getElementById('familyCodeDisplay').textContent;
            navigator.clipboard.writeText(familyCode).then(() => {
                alert('Family code copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = familyCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Family code copied to clipboard!');
            });
        }

        function copyInviteCode() {
            const inviteCode = document.getElementById('inviteCodeDisplay').textContent;
            navigator.clipboard.writeText(inviteCode).then(() => {
                alert('Family code copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = inviteCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Family code copied to clipboard!');
            });
        }

        function showWelcomePage() {
            showPage('welcome');
        }

        function showLoginPage() {
            showPage('login');

            // Clear login form
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginCaptchaInput').value = '';
            refreshCaptcha('login');
        }

        function showRegisterPage() {
            showPage('register');

            // Clear register form
            document.getElementById('regUsername').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regPurpose').value = '';
            document.getElementById('registerCaptchaInput').value = '';
            refreshCaptcha('register');
        }

        function showDashboardPage() {
            showPage('dashboard');
        }

        function showHistoryPage() {
            showPage('history');
        }

        function showStockPage() {
            showPage('stock');
        }

        function showAdminPage() {
            showPage('admin');
        }

        function showFamilyPage() {
            showPage('family');
            updateFamilyPage();
        }

        // Family Modal Functions
        function showCreateFamilyModal() {
            document.getElementById('createFamilyModal').style.display = 'block';
            document.getElementById('createFamilyName').value = '';
        }

        function closeCreateFamilyModal() {
            document.getElementById('createFamilyModal').style.display = 'none';
        }

        function showJoinFamilyModal() {
            document.getElementById('joinFamilyModal').style.display = 'block';
            document.getElementById('joinFamilyCode').value = '';
        }

        function closeJoinFamilyModal() {
            document.getElementById('joinFamilyModal').style.display = 'none';
        }

        function showInviteMemberModal() {
            const family = families.find(f => f.id === currentUser.familyId);
            if (family) {
                document.getElementById('inviteMemberModal').style.display = 'block';
                document.getElementById('inviteCodeDisplay').textContent = family.code;
            }
        }

        function closeInviteMemberModal() {
            document.getElementById('inviteMemberModal').style.display = 'none';
        }

        // Menu functions
        function toggleMenu() {
            const dropdown = document.getElementById('menuDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function showMainDashboard() {
            showDashboardPage();
            toggleMenu();
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('hamburgerMenu');
            const dropdown = document.getElementById('menuDropdown');
            if (!menu.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Password toggle
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }

        // Authentication
        function login(event) {
            event.preventDefault();

            if (!siteActive) {
                alert('System is currently deactivated. Please try again later.');
                return;
            }

            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!validateCaptcha('login')) {
                alert('Please enter the captcha text correctly!');
                refreshCaptcha('login');
                return;
            }

            // Admin credentials
            if (username === 'Aryan@8600' && password === 'Aryan@111223') {
                currentUser = {
                    username: 'Aryan@8600',
                    rank: 'admin',
                    purpose: 'both',
                    email: 'admin@expensehandler.com',
                    profilePic: avatarOptions[0]
                };
                document.getElementById('adminMenuItem').style.display = 'block';
                document.getElementById('stockMenuItem').style.display = 'block';
            } else {
                // Check registered users
                const user = registeredUsers.find(u => u.username === username && u.password === password);
                if (user) {
                    currentUser = user;
                    // Show stock menu only for users with stock or both purpose
                    if (user.purpose === 'stock' || user.purpose === 'both') {
                        document.getElementById('stockMenuItem').style.display = 'block';
                    }
                } else {
                    alert('Invalid username or password!');
                    refreshCaptcha('login');
                    return;
                }
            }

            // Update profile button
            updateProfileButton();

            // Switch to logged in state
            document.body.classList.add('logged-in');
            showDashboardPage();

            // Save to storage
            saveToStorage();

            // Reset login form
            event.target.reset();
            refreshCaptcha('login');
        }

        function register(event) {
            event.preventDefault();

            if (!siteActive) {
                alert('System is currently deactivated. Registration is not available.');
                return;
            }

            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const purpose = document.getElementById('regPurpose').value;
            const accountType = document.getElementById('accountType').value;
            const familyName = document.getElementById('familyName').value;
            const familyCode = document.getElementById('familyCode').value;

            if (!validateCaptcha('register')) {
                alert('Please enter the captcha text correctly!');
                refreshCaptcha('register');
                return;
            }

            // Validate email format
            if (!validateEmail(email)) {
                alert('‚ùå Invalid email address! Please enter a valid email.');
                return;
            }

            // Check if username already exists
            if (registeredUsers.find(u => u.username === username)) {
                alert('Username already exists!');
                return;
            }

            // Check if email already exists
            if (registeredUsers.find(u => u.email === email)) {
                alert('Email already registered! Please use a different email.');
                return;
            }

            let newUser = {
                username,
                email,
                password,
                purpose,
                rank: 'gold',
                profilePic: avatarOptions[Math.floor(Math.random() * avatarOptions.length)],
                accountType: accountType || 'individual'
            };

            // Handle family account creation or joining
            if (accountType === 'family_head') {
                if (!familyName.trim()) {
                    alert('Please enter a family name!');
                    return;
                }

                // Generate unique family code
                let generatedFamilyCode;
                do {
                    generatedFamilyCode = generateFamilyCode();
                } while (families.find(f => f.code === generatedFamilyCode));

                // Create family
                const family = {
                    id: Date.now(),
                    name: familyName.trim(),
                    code: generatedFamilyCode,
                    headId: email,
                    members: [email],
                    createdAt: new Date().toISOString()
                };

                families.push(family);
                newUser.familyId = family.id;

            } else if (accountType === 'family_member') {
                if (!familyCode.trim()) {
                    alert('Please enter a family code!');
                    return;
                }

                // Find family by code
                const family = families.find(f => f.code === familyCode.trim().toUpperCase());
                if (!family) {
                    alert('Invalid family code! Please check and try again.');
                    return;
                }

                // Add user to family
                family.members.push(email);
                newUser.familyId = family.id;
            }

            // Add user to registered users
            registeredUsers.push(newUser);

            // Save to storage
            saveToStorage();

            // Show success message and redirect
            let successMessage = '‚úÖ Account created successfully! Please login with your credentials.';
            if (accountType === 'family_head') {
                successMessage += `\n\nüëë Family "${familyName}" created!\nFamily Code: ${families.find(f => f.headId === email)?.code}\nShare this code with your family members.`;
            } else if (accountType === 'family_member') {
                const family = families.find(f => f.id === newUser.familyId);
                successMessage += `\n\nüë• Successfully joined "${family?.name}" family!`;
            }

            document.getElementById('registerSuccessMessage').textContent = successMessage;
            document.getElementById('registerSuccessMessage').classList.remove('hidden');

            setTimeout(() => {
                document.getElementById('registerSuccessMessage').classList.add('hidden');
                showLoginPage();
            }, 5000);

            // Reset form
            event.target.reset();
            toggleFamilyOptions(); // Reset family options
            refreshCaptcha('register');
        }

        function logout() {
            currentUser = null;
            document.body.classList.remove('logged-in');
            document.getElementById('adminMenuItem').style.display = 'none';
            document.getElementById('stockMenuItem').style.display = 'none';
            document.getElementById('profileBtnContainer').style.display = 'none';

            // Save to storage
            saveToStorage();

            showWelcomePage();
            toggleMenu();
        }

        // Expenses
        function addExpense(event) {
            event.preventDefault();
            const description = document.getElementById('expenseDescription').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const category = document.getElementById('expenseCategory').value;
            const reason = document.getElementById('expenseReason').value;
            const date = new Date().toISOString().split('T')[0];

            const expense = {
                id: Date.now(),
                description,
                amount,
                category,
                reason,
                date,
                user: currentUser.username
            };

            expenses.push(expense);
            updateHistoryList();

            // Save to storage
            saveToStorage();

            // Reset form
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseCategory').value = '';
            document.getElementById('expenseReason').value = '';

            // Show success message
            document.getElementById('dashboardSuccessMessage').textContent = '‚úÖ Expense added successfully!';
            document.getElementById('dashboardSuccessMessage').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('dashboardSuccessMessage').classList.add('hidden');
            }, 2000);
        }

        // History
        function filterHistory() {
            const day = document.getElementById('filterDay').value;
            const month = document.getElementById('filterMonth').value;
            const year = document.getElementById('filterYear').value;
            const category = document.getElementById('filterCategory').value;

            let filtered = expenses;

            if (day) {
                filtered = filtered.filter(expense => expense.date.split('-')[2] === day);
            }
            if (month) {
                filtered = filtered.filter(expense => expense.date.split('-')[1] === month);
            }
            if (year) {
                filtered = filtered.filter(expense => expense.date.split('-')[0] === year);
            }
            if (category) {
                filtered = filtered.filter(expense => expense.category === category);
            }

            displayHistory(filtered);
        }

        function displayHistory(items) {
            const list = document.getElementById('historyList');
            if (items.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px; background: #f8fafc; border-radius: 12px; border: 1px solid #e5e7eb;">No expenses found for the selected filters.</p>';
                return;
            }

            list.innerHTML = items.map(expense => `
                <div class="history-item">
                    <div class="history-item-header">
                        <div>
                            <strong style="color: #1f2937;">${expense.description}</strong>
                            <div style="margin-top: 4px;">
                                <span class="rank-badge rank-gold" style="font-size: 11px; padding: 4px 8px;">${expense.category || 'Uncategorized'}</span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span class="history-item-amount">‚Çπ${expense.amount.toFixed(2)}</span>
                            <button class="btn btn-danger" onclick="deleteExpense(${expense.id})" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                        </div>
                    </div>
                    <div class="history-item-date">${new Date(expense.date).toLocaleDateString()}</div>
                    <div style="margin-top: 12px; color: #4b5563; line-height: 1.5;">
                        <strong>Reason:</strong> ${expense.reason || 'No reason provided'}
                    </div>
                </div>
            `).join('');
        }

        function updateHistoryList() {
            displayHistory(expenses);
        }

        // Stock
        function addStock(event) {
            event.preventDefault();
            const item = document.getElementById('stockItem').value;
            const quantity = parseInt(document.getElementById('stockQuantity').value);
            const minLevel = parseInt(document.getElementById('stockMinLevel').value);

            const stockItem = {
                id: Date.now(),
                item,
                quantity,
                minLevel,
                status: quantity > minLevel ? 'in-stock' : 'out-of-stock'
            };

            stock.push(stockItem);
            updateStockList();

            // Save to storage
            saveToStorage();

            event.target.reset();

            // Show success message
            document.getElementById('successMessage').textContent = '‚úÖ Stock item added successfully!';
            document.getElementById('successMessage').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('successMessage').classList.add('hidden');
            }, 2000);
        }

        function filterStock(filter) {
            const filteredStock = filter === 'all' ? stock : stock.filter(item => item.status === filter);
            displayStock(filteredStock);
        }

        function displayStock(items) {
            const list = document.getElementById('stockList');
            if (items.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px; background: #f8fafc; border-radius: 12px; border: 1px solid #e5e7eb;">No stock items found.</p>';
                return;
            }

            list.innerHTML = items.map(item => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 15px; background: ${item.status === 'out-of-stock' ? '#fef2f2' : '#f0fdf4'}; transition: all 0.3s ease;">
                    <div>
                        <strong style="color: #1f2937; font-size: 16px;">${item.item}</strong>
                        <div style="color: #6b7280; margin-top: 4px;">Qty: ${item.quantity} (Min: ${item.minLevel})</div>
                        <span class="rank-badge ${item.status === 'in-stock' ? 'rank-gold' : 'rank-silver'}" style="margin-top: 8px; display: inline-block;">
                            ${item.status === 'in-stock' ? '‚úÖ In Stock' : '‚ùå Out of Stock'}
                        </span>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="deleteStock(${item.id})" style="padding: 8px 16px; font-size: 14px;">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function updateStockList() {
            displayStock(stock);
        }

        function deleteStock(id) {
            showConfirmModal('Delete Stock Item', 'Are you sure you want to delete this stock item?', () => {
                stock = stock.filter(s => s.id !== id);
                updateStockList();
                saveToStorage();
            });
        }

        // Admin functions
        function toggleSite(active) {
            const action = active ? 'activate' : 'deactivate';
            showConfirmModal(`${action.charAt(0).toUpperCase() + action.slice(1)} System`,
                `Are you sure you want to ${action} the system?`, () => {
                siteActive = active;
                const statusEl = document.getElementById('siteStatus');
                statusEl.textContent = active ? 'üü¢ System Active' : 'üî¥ System Inactive';
                statusEl.className = `site-status ${active ? 'site-active' : 'site-inactive'}`;
                saveToStorage();
            });
        }

        function changeUserRank(username, newRank) {
            showConfirmModal('Change User Rank',
                `Are you sure you want to change ${username}'s rank to ${newRank}?`, () => {
                // Update UI
                const row = event.target.closest('tr');
                const badge = row.querySelector('.rank-badge');
                badge.textContent = newRank.charAt(0).toUpperCase() + newRank.slice(1);
                badge.className = `rank-badge rank-${newRank}`;
            });
        }

        // Modal functions
        function showConfirmModal(title, message, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        }

        function confirmAction() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeModal();
        }

        // Profile functions
        function updateProfileButton() {
            if (currentUser) {
                document.getElementById('profileBtnContainer').style.display = 'block';
                document.getElementById('headerProfilePic').src = currentUser.profilePic || avatarOptions[0];
                document.getElementById('headerUsername').textContent = currentUser.username;
            }
        }

        function showProfileModal() {
            document.getElementById('profileModal').style.display = 'block';
            document.getElementById('profilePicture').src = currentUser.profilePic || avatarOptions[0];
            document.getElementById('profileUsername').value = currentUser.username;
            document.getElementById('profileEmail').value = currentUser.email;
            document.getElementById('profileRank').textContent = currentUser.rank.charAt(0).toUpperCase() + currentUser.rank.slice(1);
            document.getElementById('profileRank').className = `rank-badge rank-${currentUser.rank}`;
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
            hideAvatarSelection();
        }

        function showAvatarSelection() {
            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = avatarOptions.map((avatar, index) =>
                `<img src="${avatar}" alt="Avatar ${index + 1}" style="width: 60px; height: 60px; border-radius: 50%; cursor: pointer; border: 3px solid #e2e8f0; transition: all 0.3s ease;" onclick="selectAvatar('${avatar}')" onmouseover="this.style.borderColor='#2563eb'" onmouseout="this.style.borderColor='#e2e8f0'">`
            ).join('');
            document.getElementById('avatarSelection').style.display = 'block';
        }

        function hideAvatarSelection() {
            document.getElementById('avatarSelection').style.display = 'none';
        }

        function selectAvatar(avatarSrc) {
            document.getElementById('profilePicture').src = avatarSrc;
            currentUser.profilePic = avatarSrc;
            hideAvatarSelection();
        }

        function handleProfilePicUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageSrc = e.target.result;
                    document.getElementById('profilePicture').src = imageSrc;
                    currentUser.profilePic = imageSrc;
                };
                reader.readAsDataURL(file);
            }
        }

        function saveProfile() {
            const newUsername = document.getElementById('profileUsername').value;
            if (newUsername && newUsername !== currentUser.username) {
                // Check if username already exists
                if (registeredUsers.find(u => u.username === newUsername && u !== currentUser)) {
                    alert('Username already exists!');
                    return;
                }
                currentUser.username = newUsername;
                updateProfileButton();
            }

            // Update user in registered users array
            const userIndex = registeredUsers.findIndex(u => u.email === currentUser.email);
            if (userIndex !== -1) {
                registeredUsers[userIndex] = currentUser;
            }

            closeProfileModal();

            // Show success message
            document.getElementById('successMessage').textContent = '‚úÖ Profile updated successfully!';
            document.getElementById('successMessage').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('successMessage').classList.add('hidden');
            }, 2000);
        }

        function deleteExpense(id) {
            showConfirmModal('Delete Expense', 'Are you sure you want to delete this expense?', () => {
                expenses = expenses.filter(e => e.id !== id);
                updateHistoryList();
                saveToStorage();

                // Show success message
                document.getElementById('successMessage').textContent = '‚úÖ Expense deleted successfully!';
                document.getElementById('successMessage').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('successMessage').classList.add('hidden');
                }, 2000);
            });
        }

        // Forgot Password Functions
        function showForgotPassword() {
            showPage('forgotPassword');
            // Reset to step 1
            document.getElementById('forgotPasswordStep1').style.display = 'block';
            document.getElementById('forgotPasswordStep2').style.display = 'none';
            document.getElementById('forgotPasswordStep3').style.display = 'none';
            // Clear forms
            document.getElementById('forgotEmail').value = '';
            document.getElementById('forgotCaptchaInput').value = '';
            refreshCaptcha('forgot');
        }

        function sendResetCode(event) {
            event.preventDefault();

            if (!siteActive) {
                alert('System is currently deactivated. Password reset is not available.');
                return;
            }

            const email = document.getElementById('forgotEmail').value;

            if (!validateCaptcha('forgot')) {
                alert('Please enter the captcha text correctly!');
                refreshCaptcha('forgot');
                return;
            }

            // Check if email exists in registered users
            const user = registeredUsers.find(u => u.email === email);
            if (!user) {
                alert('No account found with this email address!');
                return;
            }

            // Generate 6-digit verification code
            const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();

            // Store reset data
            resetData = {
                email: email,
                code: verificationCode,
                timestamp: Date.now()
            };

            // In a real application, you would send this code via email
            // For demo purposes, we'll show it in an alert
            alert(`üîë Password Reset Code: ${verificationCode}\n\n(In a real application, this would be sent to your email)`);

            // Move to step 2
            document.getElementById('forgotPasswordStep1').style.display = 'none';
            document.getElementById('forgotPasswordStep2').style.display = 'block';

            // Clear step 2 form
            document.getElementById('resetCode').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        function resetPassword(event) {
            event.preventDefault();

            const enteredCode = document.getElementById('resetCode').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Check if code is valid and not expired (15 minutes)
            const codeAge = Date.now() - resetData.timestamp;
            const fifteenMinutes = 15 * 60 * 1000;

            if (codeAge > fifteenMinutes) {
                alert('Verification code has expired. Please request a new one.');
                backToStep1();
                return;
            }

            if (enteredCode !== resetData.code) {
                alert('Invalid verification code. Please try again.');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match. Please try again.');
                return;
            }

            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long.');
                return;
            }

            // Update user password
            const userIndex = registeredUsers.findIndex(u => u.email === resetData.email);
            if (userIndex !== -1) {
                registeredUsers[userIndex].password = newPassword;
            }

            // Save to storage
            saveToStorage();

            // Clear reset data
            resetData = { email: '', code: '', timestamp: 0 };

            // Move to step 3 (success)
            document.getElementById('forgotPasswordStep2').style.display = 'none';
            document.getElementById('forgotPasswordStep3').style.display = 'block';
        }

        function backToStep1() {
            document.getElementById('forgotPasswordStep2').style.display = 'none';
            document.getElementById('forgotPasswordStep1').style.display = 'block';

            // Clear reset data
            resetData = { email: '', code: '', timestamp: 0 };

            // Clear forms
            document.getElementById('forgotEmail').value = '';
            document.getElementById('forgotCaptchaInput').value = '';
            refreshCaptcha('forgot');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const confirmModal = document.getElementById('confirmModal');
            const profileModal = document.getElementById('profileModal');
            const addCategoryModal = document.getElementById('addCategoryModal');
            const createFamilyModal = document.getElementById('createFamilyModal');
            const joinFamilyModal = document.getElementById('joinFamilyModal');
            const inviteMemberModal = document.getElementById('inviteMemberModal');

            if (event.target === confirmModal) {
                closeModal();
            }
            if (event.target === profileModal) {
                closeProfileModal();
            }
            if (event.target === addCategoryModal) {
                closeAddCategoryModal();
            }
            if (event.target === createFamilyModal) {
                closeCreateFamilyModal();
            }
            if (event.target === joinFamilyModal) {
                closeJoinFamilyModal();
            }
            if (event.target === inviteMemberModal) {
                closeInviteMemberModal();
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9686164ed6493e1b',t:'MTc1NDA1OTE5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

